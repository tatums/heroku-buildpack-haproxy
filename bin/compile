#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3


LUA_MAJOR=5.3
LUA_VERSION=5.3.4
LUA_MD5=53a9c68bcc0eda58bdc2095ad5cdfc63

LUA_ARCHIVE=lua-${LUA_VERSION}.tar.gz
LUA_ARCHIVE_DIR=lua-${LUA_VERSION}


HAPROXY_MAJOR=1.8
HAPROXY_VERSION=1.8.3
HAPROXY_MD5=2e1e3eb42f07983c9303c5622d812862

HAPROXY_ARCHIVE=haproxy-${HAPROXY_VERSION}.tar.gz
HAPROXY_ARCHIVE_DIR=haproxy-${HAPROXY_VERSION}

echo

mkdir -p $CACHE_DIR


### START LUA
if [ ! -e $CACHE_DIR/$LUA_ARCHIVE ]; then
  echo "-----> Downloading ${LUA_ARCHIVE} from http://www.lua.org ..."
  curl -sSL "http://www.lua.org/ftp/${LUA_ARCHIVE}" -o "${CACHE_DIR}/${LUA_ARCHIVE}"
  echo "       Done"
else
  echo "-----> Using a locally cached copy of ${LUA_ARCHIVE}"
fi

if ! (echo "${LUA_MD5}  ${CACHE_DIR}/${LUA_ARCHIVE}" | md5sum -c --quiet); then
  echo " !     Failed to verify authenticity of ${LUA_ARCHIVE} (should be ${LUA_MD5})"
  exit 1
fi

if [ ! -d $CACHE_DIR/$LUA_ARCHIVE_DIR ]; then
  echo "-----> Unpacking ${LUA_ARCHIVE} to ${CACHE_DIR}/${LUA_ARCHIVE_DIR}"
  mkdir -p "${CACHE_DIR}/${LUA_ARCHIVE_DIR}"
  tar -xzf "${CACHE_DIR}/${LUA_ARCHIVE}" -C "${CACHE_DIR}/${LUA_ARCHIVE_DIR}" --strip-components=1
  echo "       Done"
fi

echo "\n\nMAKE ---> ${CACHE_DIR}/${LUA_ARCHIVE_DIR}\n\n"
make -sC "${CACHE_DIR}/${LUA_ARCHIVE_DIR}" \
  INSTALL_TOP=/opt/lua53 \
  install
### END LUA



if [ ! -e $CACHE_DIR/$HAPROXY_ARCHIVE ]; then
  echo "-----> Downloading ${HAPROXY_ARCHIVE} from http://www.haproxy.org/..."
  curl -sSL "http://www.haproxy.org/download/${HAPROXY_MAJOR}/src/haproxy-${HAPROXY_VERSION}.tar.gz" -o $CACHE_DIR/$HAPROXY_ARCHIVE
  echo "       Done"
else
  echo "-----> Using a locally cached copy of ${HAPROXY_ARCHIVE}"
fi

if ! (echo "${HAPROXY_MD5}  ${CACHE_DIR}/${HAPROXY_ARCHIVE}" | md5sum -c --quiet); then
  echo " !     Failed to verify authenticity of ${HAPROXY_ARCHIVE} (should be ${HAPROXY_MD5})"
  exit 1
fi

if [ ! -d $CACHE_DIR/$HAPROXY_ARCHIVE_DIR ]; then
  echo "-----> Unpacking ${HAPROXY_ARCHIVE} to ${CACHE_DIR}/${HAPROXY_ARCHIVE_DIR}"
  mkdir -p "${CACHE_DIR}/${HAPROXY_ARCHIVE_DIR}"
  tar -xzf "${CACHE_DIR}/${HAPROXY_ARCHIVE}" -C "${CACHE_DIR}/${HAPROXY_ARCHIVE_DIR}" --strip-components=1
  echo "       Done"
fi

echo
echo "-----> Compiling..."
#  USE_LUA=1 \

make -sC "${CACHE_DIR}/${HAPROXY_ARCHIVE_DIR}" \
	TARGET=linux2628 \
	USE_PCRE=1 PCREDIR= \
	USE_OPENSSL=1 \
	USE_ZLIB=1 \
  PREFIX=$BUILD_DIR \
	all \
	install-bin

echo "       Done"

exit 0
